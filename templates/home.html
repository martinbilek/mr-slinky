<!doctype html>
<html lang='en'>
<head>
    <title>Mr. Slinky</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .top {
            flex: 0 0 60%;
            flex-direction: column;
            background: rgb(250, 104, 49);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .top .steps {
            display: block;
            width: 100%;
            text-align: center;
            font-weight: bold;
            font-size: 8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .top .description {
            display: block;
            width: 100%;
            text-align: center;
            font-size: 2em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bottom {
            flex: 0 0 40%;
            display: flex;
        }

        .bottom-left {
            flex: 0 0 50%;
            flex-direction: column;
            background: #fff;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottom-left .speed {
            display: block;
            width: 100%;
            text-align: center;
            font-weight: bold;
            font-size: 4em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bottom-right {
            flex: 0 0 50%;
            flex-direction: column;
            background: #fff;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottom-right .speed {
            display: block;
            width: 100%;
            text-align: center;
            font-weight: bold;
            font-size: 4em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .menu {
            display: none;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 200px;
        }

        .menu .button {
            display: flex;
            width: auto;
            height: 31.5%;
            border: 5px solid #fff;
            background: #ccc;
            text-align: center;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container" onclick="toggleMenu()">
        <div class="top">
            <div id="steps-count" class="steps"></div>
            <div class="description">Mr. Slinkyâ€™s journey in steps</div>
        </div>
        <div class="bottom">
            <div class="bottom-left">
                <div id="avg-steps-min" class="speed"></div>
                <div class="description">Steps per minute</div>
            </div>
            <div class='bottom-right'>
                <div class="speed" id="avg-speed-sec"></div>
                <div class="description">Seconds to complete one step</div>
            </div>
        </div>
    </div>
    <div class="menu" id="menu">
        <div class="button" onclick="reloadPage()">Reload page</div>
        <div class="button" onclick="toggleMotor()">Toggle motor</div>
        <div class="button" onclick="toggleFullscreen()">Toggle Fullscreen</div>
    </div>
</body>

<script>
function toggleMotor() {
    fetch('/toggle-motor', {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            updateData();
        } else {
            console.error('Toggle motor failed');
        }
    });
    toggleMenu();
}

let startTime = null;
let startStepCount = null;
const speedHistory = [];
const maxHistory = 10;

function updateData() {
    fetch('/data')
        .then(response => response.json())
        .then(data => {
            const steps = data.steps_count;

            // Initialize on first fetch
            if (startTime === null) {
                startTime = Date.now();
                startStepCount = steps;
            }

            // Calculate steps per minute
            const elapsedMs = Date.now() - startTime;
            const elapsedMin = elapsedMs / 60000;
            const stepsTraveled = steps - startStepCount;

            const speed = stepsTraveled / elapsedMin;

            // Store in history
            speedHistory.push(speed);
            if (speedHistory.length > maxHistory) {
                speedHistory.shift();
            }

            // Average of last N speeds
            const avgSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;

            document.getElementById('steps-count').textContent = steps.toLocaleString('en').replace(/,/g, '.');
            document.getElementById('avg-steps-min').textContent = avgSpeed.toFixed(2);
            document.getElementById('avg-speed-sec').textContent = (60 / avgSpeed).toFixed(2);
        });
}

function toggleFullscreen() {
    const el = document.documentElement;

    if (
        document.fullscreenElement ||
        document.webkitFullscreenElement ||
        document.mozFullScreenElement ||
        document.msFullscreenElement
    ) {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    } else {
        if (el.requestFullscreen) {
            el.requestFullscreen();
        } else if (el.webkitRequestFullscreen) {
            el.webkitRequestFullscreen();
        } else if (el.mozRequestFullScreen) {
            el.mozRequestFullScreen();
        } else if (el.msRequestFullscreen) {
            el.msRequestFullscreen();
        }
    }

    toggleMenu();
}

function toggleMenu() {
    let menu = document.getElementById('menu');
    if (menu.style.display === 'none') {
        menu.style.display = 'block';
    } else {
        menu.style.display = 'none';
    }
}

function reloadPage() {
    location.reload();
}

window.onload = updateData;
setInterval(updateData, 900);
</script>
</html>